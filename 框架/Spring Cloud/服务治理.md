# 服务治理

在微服务架构中，各个微服务实例的一个重要能力就是可以快速上、下线，让服务能够快速地进行水平扩展，保证服务的可用性。此时服务消费者与这些不断上下线的服务提供者如何保持正常通信就成了首要解决的问题。**服务治理**就是用来解决这个问题。

服务治理通过抽象将服务消费者和服务提供者进行隔离。消费者不需要知道服务提供者的真实物理地址就可以进行调用，也不需要有多少个服务提供者可调用。服务提供者只需要将自己注册到服务治理服务器中就可以对外提供服务，不需要具体哪些服务调用了自己。

## CAP定理

CAP定理：对于一个分布式计算机系统来说，**不可能**同时满足以下三个特点：

- 一致性(Consistency)：同一个数据在集群中的所有节点，同一时刻都是同样的值。
- 可用性(Availability)：集群中一部分节点故障后，集群整理能同时处理客户端的请求。
- 分区容忍性(Partition tolerance)：允许数据分区（集群中节点之间无法通信）

这三个特性在任何分布式系统中都不可能同时满足，最多同时满足其中两个。

对于大多数分布式环境，数据一致性应是首先应被保证的，**Zookeeper**采用的设计原则就是CP原则：任何时刻对Zookeeper的访问请求能得到一致性的数据结果，同时系统对网络分割具备容错性，但他不能保证每次请求对服务的可用性。

对于一般微服务的治理而言，核心就是服务的注册和发现。针对同一个服务，即使注册中心的不同节点保存的服务提供者信息不一致，也不会造成严重的后果。对于服务消费者来说，能消费才是最重要的。所以像**Eureka**这种注册中心，遵循的就是AP原则：可用性优先。

### Eureka与Zookeeper区别

Spring Cloud Eureka实现的服务治理机制强调了CAP原理中的AP，即可用性与可靠性，而Zookeeper这类强调CP（一致性、可靠性）。Eureka为了实现更高的服务可用性，牺牲了一定的一致性，在极端情况下它宁愿接受故障实例也不要丢掉“健康”实例，比如，当服务注册中心的网络发生故障断开时，由于所有的服务实例无法维持续约心跳，在强调CP的服务治理中将会把所有服务实例都剔除掉，而Eureka则会触发保护机制，保留此时的所有节点，以实现服务间依然可以进行互相调用的场景。



# 参考

- Spring Cloud 微服务架构开发实战
- [Spring Cloud Zookeeper实现服务注册与发现](<https://www.jianshu.com/p/4404bddea7c6>)
- [Spring Cloud（三） zookeeper实现服务治理](<https://my.oschina.net/u/3737136/blog/1927660>)