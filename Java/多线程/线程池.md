# 线程池

## 什么是线程池

> 线程池是一种线程使用模式。
>
> 线程过多会带来调度开销，进而影响缓存局部性和整体性能。线程池维护多个线程，等待着CPU分配可并发执行的任务。使用线程池避免了在处理短时间任务时创建与销毁线程的代价。

### 为什么要使用线程池

- 创建/销毁线程需要消耗系统资源，线程池可以**复用已创建的线程**。
- 控制并发数量。并发数量过多可能会导致系统资源过多，进而导致服务器崩溃。
- 可对线程做统一管理。

## 线程池的原理

> 线程池顶层接口是Executor接口，ThreadPoolExecutor是实现类。

### 几个概念

#### 核心线程

> 线程池中有两类线程：核心线程和非核心线程。
>
> 核心线程默认情况下回一直存在于线程池中，即使这个线程什么都不干。
>
> 非核心线程如果长时间闲置，会被销毁。

#### 阻塞队列

> 维护等待执行Runnable任务对象的队列。

### ThreadPoolExecutor策略

> 线程池本身也是一个线程。只是这个线程是用于管理布控整个线程池里的各种任务和事务，比如创建、销毁线程，任务队列管理，线程队列管理。。
>
> 线程池有自己的状态：RUNNING、SHUTDOWN、STOP、TIDYING、TERMINATED。这几个状态由一个voilatile int的变量runState来表示。
>
> 线程池状态转换：
>
> - 线程池创建后处于RUNNING；
> - 调用shutdown()后处于SHUTDOWN状态，此时线程池不能接受新的任务，会清楚一些空闲的woker，会等待阻塞队列的任务完成。
> - 调用shutdownNow()后处于STOP状态，此时线程池一样不能接受新的任务，并且会中断所有线程，阻塞队列中没有被执行的任务也会全部丢弃。此时，线程池的poolSize =0, 阻塞队列的大小也为0。
> - 当所有的任务都已经终止，ctl记录的任务数量也为0，此时线程池的状态会变为TIDYING。紧接着会执行teminated()。
> - 执行terminated()后，线程池的状态被设置为TERMINATED状态。

