# 服务治理

在微服务架构中，各个微服务实例的一个重要能力就是可以快速上、下线，让服务能够快速地进行水平扩展，保证服务的可用性。此时服务消费者与这些不断上下线的服务提供者如何保持正常通信就成了首要解决的问题。**服务治理**就是用来解决这个问题。

服务治理通过抽象将服务消费者和服务提供者进行隔离。消费者不需要知道服务提供者的真实物理地址就可以进行调用，也不需要有多少个服务提供者可调用。服务提供者只需要将自己注册到服务治理服务器中就可以对外提供服务，不需要具体哪些服务调用了自己。

## Eureka服务发现，服务注册相关原理

![Eureka架构图](/imgs/Eureka架构图.jpg)

### 服务注册

在微服务架构中，一个服务提供者本质上也是一个Eureka客户端。启动时，也会调用Eureka所提供的服务注册相关方法，向Eureka服务器注册自己的信息。

同时，在Eureka服务器会维护一个已注册的服务列表。注册服务列表使用一个嵌套的HashMap保存信息。

> HashMap的第一层为应用名称和对应的服务实例。
>
> 第二层为服务实例对应的注册信息，包括宿主服务IP地址、服务端口、运行状况指示符、URL等数据。

服务状态发生变化时，会向Eureka服务器更新自己的服务状态，同时向其他Eureka服务器节点做状态同步。（如果配置了register-with-eureka为false就不会同步状态）

### 服务续约

当启动客户端并且成功注册到Eureka服务器后，客户端会以默认每30s一次的频率（可通过lease-renewal-interval-in-seconds属性配置）向Eureka服务器发送心跳。发送心跳的操作就是执行**服务续约**操作，服务续约能避免自己的注册信息被Eureka服务器移除。续约的逻辑更注册基本一致，先更新自身状态，再同步到其他服务器节点。

对于服务器而言，如果连续三次（默认90s）没有收到客户端的心跳，就会将客户端的服务实例从服务注册表中剔除。

### 服务下线

服务实例关闭时，会向Eureka服务器发送服务下线请求。发送成功后服务器会将该节点从注册表中移除。

### 获取服务

客户端在启动时会从Eureka服务起拉取注册表信息，并缓存至本地。

客户端在调用服务时会首先获取缓存内的信息并进行调用。注册表信息定期（默认每隔30s）与服务器进行同步。

如果在调用时发现调用不能及时匹配，客户端会重新拉取整个注册表信息。

## Zookeeper

Zookeeper是一个开源的分布式协调服务。分布式应用程序可以基于Zookeeper实现诸如发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master选举、分布式锁和分布式队列等功能。

### 几个基本概念

#### 集群角色

在Zookeeper中，有三种角色：

- Leader
- Follower
- Observer

在一个Zookeeper集群中，同一时刻只会有一个Leader，其余都是Follower或Observer。Zookeeper默认只有Leader和Follower两种角色。如果想要使用Observer模式，需在对应节点的zoo.cfg添加配置`peerType=observer`，并且还需在所有节点zoo.cfg的server配置末尾追加`:observer`， 例如：

```
server.1:localhost:2888:3888:observer
```





在zk节点的配置中，myid文件的值必须和zoo.cfg中`server.{数值}` 的{数值}部分一致。

查看当前节点的Zookeeper是什么角色（Mode，单机模式Mode：standalone），在Zookeeper安装目录的bin目录下：

```
./zkServer.sh status
```



Zookeeper的相关配置： 

## CAP定理

CAP定理：对于一个分布式计算机系统来说，**不可能**同时满足以下三个特点：

- 一致性(Consistency)：同一个数据在集群中的所有节点，同一时刻都是同样的值。
- 可用性(Availability)：集群中一部分节点故障后，集群整理能同时处理客户端的请求。
- 分区容忍性(Partition tolerance)：允许数据分区（集群中节点之间无法通信）

这三个特性在任何分布式系统中都不可能同时满足，最多同时满足其中两个。

对于大多数分布式环境，数据一致性应是首先应被保证的，**Zookeeper**采用的设计原则就是CP原则：任何时刻对Zookeeper的访问请求能得到一致性的数据结果，同时系统对网络分割具备容错性，但他不能保证每次请求对服务的可用性。

对于一般微服务的治理而言，核心就是服务的注册和发现。针对同一个服务，即使注册中心的不同节点保存的服务提供者信息不一致，也不会造成严重的后果。对于服务消费者来说，能消费才是最重要的。所以像**Eureka**这种注册中心，遵循的就是AP原则：可用性优先。

### Eureka与Zookeeper区别

Spring Cloud Eureka实现的服务治理机制强调了CAP原理中的AP，即可用性与可靠性，而Zookeeper这类强调CP（一致性、可靠性）。Eureka为了实现更高的服务可用性，牺牲了一定的一致性，在极端情况下它宁愿接受故障实例也不要丢掉“健康”实例，比如，当服务注册中心的网络发生故障断开时，由于所有的服务实例无法维持续约心跳，在强调CP的服务治理中将会把所有服务实例都剔除掉，而Eureka则会触发保护机制，保留此时的所有节点，以实现服务间依然可以进行互相调用的场景。



# 参考

- Spring Cloud 微服务架构开发实战
- Spring Cloud微服务架构进阶
- [Spring Cloud Zookeeper实现服务注册与发现](<https://www.jianshu.com/p/4404bddea7c6>)
- [Spring Cloud（三） zookeeper实现服务治理](<https://my.oschina.net/u/3737136/blog/1927660>)